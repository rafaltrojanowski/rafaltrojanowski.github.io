<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>My first dive into DDD concepts in Ruby · Rafal Trojanowski - Ruby on Rails Developer</title><meta name="description" content="I'm remote Ruby on Rails Developer based in Poland"><meta name="og:title" content="My first dive into DDD concepts in Ruby"><meta name="og:type" content="website"><meta name="og:url" content="http://rafaltrojanowski.github.io/2020/10/21/my-first-dive-into-ddd-in-ruby/"><meta name="og:image" content="http://image.toast.com/aaaaahq/hola_cover.JPG"><meta name="og:description" content="I'm remote Ruby on Rails Developer based in Poland"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/chiangmai.css"><meta name="steem:author" content="@stunstunstun"><meta name="fb:app_id" content="1279423065775877"><link rel="search" type="application/opensearchdescription+xml" href="http://rafaltrojanowski.github.io/atom.xml" title="Rafal Trojanowski - Ruby on Rails Developer"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Rafal Trojanowski - Ruby on Rails Developer" type="application/atom+xml">
</head><body class="post"><div id="fb-root"></div><div class="wrap"><header><nav class="navi-post"><a class="navi-post-back" href="javascript:history.back()"><i class="fa fa-arrow-left" aria-hidden="true"></i></a><a class="navi-post-home" href="/"><i class="fa fa-home" aria-hidden="true"></i></a></nav></header><main class="post"><div class="post"><article class="post-block"><h1 class="post-title">My first dive into DDD concepts in Ruby</h1><div class="post-info"><div class="post-info-profile"><a href="https://github.com/rafaltrojanowski" target="_blank"><img src="/image/rt-avatar.jpg"></a></div><div class="post-info-details"><div class="post-categories"></div><div class="post-date">Oct 21, 2020</div></div></div><div class="post-share"><div class="fb-like" data-href="http://rafaltrojanowski.github.io/2020/10/21/my-first-dive-into-ddd-in-ruby/" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="false">                 </div><div class="fb-share-button" data-href="http://rafaltrojanowski.github.io/2020/10/21/my-first-dive-into-ddd-in-ruby/" data-layout="button" data-size="small" data-mobile-iframe="true"></div><div class="fb-follow" data-href="/" data-layout="button_count" data-size="small" data-show-faces="true"></div></div><div class="post-content"><h3>Intro</h3>

<p>For someone who is experiencing Rails fatigue, it would be worth looking into alternatives for developing architectures with Ruby. It does not mean that it would require abandoning Rails at all because there are solutions that allow developing DDD concepts with the most popular Ruby framework. I will leave a discussion about whether you need this architecture approach in your app or not and only focus on how to start with DDD if you are not familiar with it.</p>
<h2>Possible solutions</h2>

<p>Based on my research, it looks like there are two possible ways to go with DDD in Ruby. The first one is Eventide with code examples available here: <a href="https://github.com/eventide-examples" target="_blank" rel="noopener">https://github.com/eventide-examples</a><br>These are pure Ruby examples. There is also the Eventide Rails project. However, not much is going there:<br><a href="https://github.com/eventide-project/eventide-rails" target="_blank" rel="noopener">https://github.com/eventide-project/eventide-rails</a><br>The second one is the Rails Event Store with a demo app: <a href="https://github.com/RailsEventStore/cqrs-es-sample-with-res" target="_blank" rel="noopener">https://github.com/RailsEventStore/cqrs-es-sample-with-res</a><br>It is integration with Rails, and a demo is also available on Heroku, which makes it very easy to play with it. </p>
<p>After having a look into Eventide examples and the CQRS project, what is similar between them is the concept of Commands and Events. For someone familiar with Rails who want to get hands dirty with Domain-Driven Design,  I believe that the great place to start is cqrs-es-sample-with-res repo from Rails Event Store. So let’s have a look.</p>
<h2>Rails Event Store</h2>

<p>As you probably know from the previous section, the gem that brings all the necessary things to start the journey with Domain-Driven Design and Rails is called Rails Event Store.<br>The demo repo is actively maintained, consists of a use case of an e-commerce store with the implementation of around ten events that model business operations. For those who want to learn more, there are also Docs available here: <a href="https://railseventstore.org/" target="_blank" rel="noopener">https://railseventstore.org/</a></p>
<p>I decided to run a demo project locally, generate some events, and then connect database GUI client to see how Events have been stored in the database and what’s going on with other data like typical Rails models. Later on, to fully understand how things work, I added my custom Event.</p>
<h3>Adding custom event</h3>

<h4> Step 1. Trigger command in Rails controller.</h4>

<p>This part is easy. So here is where all the journey starts. I decided to add a tracking event when the user visits the Order page, so I need to call the following code in OrdersController#show action:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/controllers/orders_controller.rb</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">     @order       = Orders::Order.find(params[<span class="symbol">:id</span>])</span><br><span class="line">     @order_lines = Orders::OrderLine.where(<span class="symbol">order_uid:</span> @order.uid)</span><br><span class="line">+    command_bus.(Ordering::VisitOrder.new(<span class="symbol">order_uid:</span> @order.uid))</span><br><span class="line">   <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>The integration of this code with a controller requires changes in two other places. We need to register our command:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ordering/lib/ordering/visit_order.rb</span></span><br><span class="line">+<span class="class"><span class="keyword">module</span> <span class="title">Ordering</span></span></span><br><span class="line">+  <span class="class"><span class="keyword">class</span> <span class="title">VisitOrder</span> &lt; Command</span></span><br><span class="line">+    attribute <span class="symbol">:order_uid</span>, Types::UUID</span><br><span class="line">+  <span class="keyword">end</span></span><br><span class="line">+<span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>To finalize this part, the configuration for our command bus is needed:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config/initializers/rails_event_store.rb</span></span><br><span class="line">   Rails.configuration.command_bus.tap <span class="keyword">do</span> <span class="params">|bus|</span></span><br><span class="line">+    bus.register(Ordering::VisitOrder, Ordering::OnVisitOrder.new)</span><br><span class="line">   <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4> Step 2. Command Handler.</h4>

<p>The next step is to handle our Command in the following file:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ordering/lib/ordering/on_visit_order.rb</span></span><br><span class="line">+<span class="class"><span class="keyword">module</span> <span class="title">Ordering</span></span></span><br><span class="line">+  <span class="class"><span class="keyword">class</span> <span class="title">OnVisitOrder</span></span></span><br><span class="line">+    <span class="keyword">include</span> CommandHandler</span><br><span class="line">+</span><br><span class="line">+    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(command)</span></span></span><br><span class="line">+      with_aggregate(Order, command.order_uid) <span class="keyword">do</span> <span class="params">|order|</span></span><br><span class="line">+        order.visit</span><br><span class="line">+      <span class="keyword">end</span></span><br><span class="line">+    <span class="keyword">end</span></span><br><span class="line">+  <span class="keyword">end</span></span><br><span class="line">+<span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>The code above calls the Order#visit instance method, which implements the following code:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ordering/lib/ordering/order.rb</span></span><br><span class="line">+<span class="function"><span class="keyword">def</span> <span class="title">visit</span></span></span><br><span class="line">+  apply OrderVisited.new(<span class="symbol">data:</span> &#123;<span class="symbol">order_id:</span> @id&#125;)</span><br><span class="line">+<span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4> Step 3. The last part, Event.</h4>

<p>And here is the moment where I got stuck for a moment. I got the following error:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Missing handler method apply_order_visited on aggregate Ordering::Order</span><br></pre></td></tr></table></figure>

<p>Let’s fix it by adding the following code in the same file:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ordering/lib/ordering/order.rb</span></span><br><span class="line">+on OrderVisited <span class="keyword">do</span> <span class="params">|event|</span></span><br><span class="line">+  <span class="comment"># do nothing</span></span><br><span class="line">+<span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>The last part is to handle our Event. To do this, we need to update our code in a few places. Add an Event:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ordering/lib/ordering/order_visited.rb</span></span><br><span class="line">+<span class="class"><span class="keyword">module</span> <span class="title">Ordering</span></span></span><br><span class="line">+  <span class="class"><span class="keyword">class</span> <span class="title">OrderVisited</span> &lt; Event</span></span><br><span class="line">+    attribute <span class="symbol">:order_id</span>, Types::UUID</span><br><span class="line">+  <span class="keyword">end</span></span><br><span class="line">+<span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Add subscription in config:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#config/initializers/rails_event_store.rb</span></span><br><span class="line">  Rails.configuration.event_store.tap <span class="keyword">do</span> <span class="params">|store|</span></span><br><span class="line">+    store.subscribe(Orders::OnOrderVisited, <span class="symbol">to:</span> [Ordering::OrderVisited])</span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>And the final part where the actual business logic happens is our read model. This read model is placed all together with other models like order or order_line (ActiveRecord):</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/read_models/orders/on_order_visited.rb</span></span><br><span class="line">+<span class="class"><span class="keyword">module</span> <span class="title">Orders</span></span></span><br><span class="line">+  <span class="class"><span class="keyword">class</span> <span class="title">OnOrderVisited</span></span></span><br><span class="line">+    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(event)</span></span></span><br><span class="line">+      order = Order.find_by(<span class="symbol">uid:</span> event.data[<span class="symbol">:order_id</span>])</span><br><span class="line">+</span><br><span class="line">+      order.visit_count += <span class="number">1</span></span><br><span class="line">+      order.save!</span><br><span class="line">+    <span class="keyword">end</span></span><br><span class="line">+  <span class="keyword">end</span></span><br><span class="line">+<span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3>Conclusion</h3>

<p>Because there is no Demo app for the Eventide project that shows how to integrate it with Rails, I decided to go with RES to learn more about DDD. For someone already familiar with DDD concepts, it would be good to give Eventide repo a shoot. Check this blog post for more info: <a href="https://blog.arkency.com/my-first-10-minutes-with-eventide/" target="_blank" rel="noopener">https://blog.arkency.com/my-first-10-minutes-with-eventide/</a></p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2020/09/21/how-to-dockerize-rails-6-app/"><i class="fa fa-arrow-left" aria-hidden="true"></i></a><a class="next" href="/2020/11/03/visualize-four-types-of-joins-in-rails/"><i class="fa fa-arrow-right" aria-hidden="true"></i></a></div><div class="fb-comments-area"><div class="fb-comments" data-href="http://rafaltrojanowski.github.io/2020/10/21/my-first-dive-into-ddd-in-ruby/" data-width="700" data-numposts="5"></div></div><div class="copyright"><p>© 2012 - 2024 <a href="https://github.com/stunstunstun" target="_blank">Rafał Trojanowski</a>. Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/stunstunstun/hexo-theme-chiangmai" target="_blank">hexo-theme-chiangmai</a>.</p></div></footer></div><script>window.fbAsyncInit=function(){FB.init({appId:"1279423065775877",cookie:!0,xfbml:!0,version:"v2.8"}),FB.AppEvents.logPageView()},function(e,n,t){var o,c=e.getElementsByTagName(n)[0];e.getElementById(t)||((o=e.createElement(n)).id=t,o.src="//connect.facebook.net/en_US/sdk.js",c.parentNode.insertBefore(o,c))}(document,"script","facebook-jssdk");</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create','UA-112438069-1','auto');ga('send','pageview');</script></body></html>