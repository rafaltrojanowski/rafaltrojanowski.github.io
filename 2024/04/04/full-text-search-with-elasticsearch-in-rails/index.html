<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Getting started with Full-text Search with Elasticsearch in Rails · Rafal Trojanowski - Ruby on Rails Developer</title><meta name="description" content="I'm remote Ruby on Rails Developer based in Poland"><meta name="og:title" content="Getting started with Full-text Search with Elasticsearch in Rails"><meta name="og:type" content="website"><meta name="og:url" content="http://rafaltrojanowski.github.io/2024/04/04/full-text-search-with-elasticsearch-in-rails/"><meta name="og:image" content="http://image.toast.com/aaaaahq/hola_cover.JPG"><meta name="og:description" content="I'm remote Ruby on Rails Developer based in Poland"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/chiangmai.css"><meta name="steem:author" content="@stunstunstun"><meta name="fb:app_id" content="1279423065775877"><link rel="search" type="application/opensearchdescription+xml" href="http://rafaltrojanowski.github.io/atom.xml" title="Rafal Trojanowski - Ruby on Rails Developer"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Rafal Trojanowski - Ruby on Rails Developer" type="application/atom+xml">
</head><body class="post"><div id="fb-root"></div><div class="wrap"><header><nav class="navi-post"><a class="navi-post-back" href="javascript:history.back()"><i class="fa fa-arrow-left" aria-hidden="true"></i></a><a class="navi-post-home" href="/"><i class="fa fa-home" aria-hidden="true"></i></a></nav></header><main class="post"><div class="post"><article class="post-block"><h1 class="post-title">Getting started with Full-text Search with Elasticsearch in Rails</h1><div class="post-info"><div class="post-info-profile"><a href="https://github.com/rafaltrojanowski" target="_blank"><img src="/image/rt-avatar.jpg"></a></div><div class="post-info-details"><div class="post-categories"></div><div class="post-date">Apr 4, 2024</div></div></div><div class="post-share"><div class="fb-like" data-href="http://rafaltrojanowski.github.io/2024/04/04/full-text-search-with-elasticsearch-in-rails/" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="false">                 </div><div class="fb-share-button" data-href="http://rafaltrojanowski.github.io/2024/04/04/full-text-search-with-elasticsearch-in-rails/" data-layout="button" data-size="small" data-mobile-iframe="true"></div><div class="fb-follow" data-href="https://www.facebook.com/rafalltrojanowski" data-layout="button_count" data-size="small" data-show-faces="true"></div></div><div class="post-content"><h1> Installation and Setting Up</h1>

<h2>Install Elasticsearch on macOS with Homebrew</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">% brew tap elastic&#x2F;tap</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">% brew install elastic&#x2F;tap&#x2F;elasticsearch-full</span><br></pre></td></tr></table></figure>
<p>Check elasticsearch version</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch --version</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Version: 7.17.4, Build: default&#x2F;tar&#x2F;79878662c54c886ae89206c685d9f1051a9d6411&#x2F;2022-05-18T18:04:20.964345128Z, JVM: 18.0.1.1)</span><br></pre></td></tr></table></figure>
<p>Run elasticsearch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ elasticsearch</span><br></pre></td></tr></table></figure>
<p>Visit <a href="http://localhost:9200/" target="_blank" rel="noopener">http://localhost:9200/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Rafas-MacBook-Pro.local&quot;,</span><br><span class="line">  &quot;cluster_name&quot;: &quot;elasticsearch_rafaltrojanowski&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot;: &quot;oM3h-13nSWSGurimF2cUIg&quot;,</span><br><span class="line">  &quot;version&quot;: &#123;</span><br><span class="line">    &quot;number&quot;: &quot;7.17.4&quot;,</span><br><span class="line">    &quot;build_flavor&quot;: &quot;default&quot;,</span><br><span class="line">    &quot;build_type&quot;: &quot;tar&quot;,</span><br><span class="line">    &quot;build_hash&quot;: &quot;79878662c54c886ae89206c685d9f1051a9d6411&quot;,</span><br><span class="line">    &quot;build_date&quot;: &quot;2022-05-18T18:04:20.964345128Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot;: false,</span><br><span class="line">    &quot;lucene_version&quot;: &quot;8.11.1&quot;,</span><br><span class="line">    &quot;minimum_wire_compatibility_version&quot;: &quot;6.8.0&quot;,</span><br><span class="line">    &quot;minimum_index_compatibility_version&quot;: &quot;6.0.0-beta1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot;: &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="NOTE"><a href="#NOTE" class="headerlink" title="NOTE"></a>NOTE</h6><p>Install <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/targz.html#install-macos" target="_blank" rel="noopener">Elasticsearch</a> version 8.x from archive on Linux or MacOS</p>
<h6 id="Install-kibana"><a href="#Install-kibana" class="headerlink" title="Install kibana"></a>Install kibana</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install elastic&#x2F;tap&#x2F;kibana-full</span><br></pre></td></tr></table></figure>

<p>Note: Kibana version must match with Elasticsearch version.</p>
<h2 id="Rails-project"><a href="#Rails-project" class="headerlink" title="Rails project"></a>Rails project</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ gem install rails</span><br><span class="line">$ rails new blog --database&#x3D;postgresql</span><br><span class="line">$ cd blog</span><br><span class="line">$ rails g scaffold Article title:string body:text</span><br><span class="line">$ rake db:create &amp;&amp; rake db:migrate</span><br></pre></td></tr></table></figure>

<p>Visit <a href="http://localhost:3000/articles" target="_blank" rel="noopener">http://localhost:3000/articles</a> </p>
<p>There is now data yet, we will populate it later.</p>
<figure class="highlight ruby"><figcaption><span>Gemfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gem <span class="string">'elasticsearch-model'</span></span><br><span class="line">gem <span class="string">'elasticsearch-rails'</span></span><br><span class="line"></span><br><span class="line">group <span class="symbol">:development</span>, <span class="symbol">:test</span> <span class="keyword">do</span></span><br><span class="line">  gem <span class="string">'ffaker'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rails g model user first_name:string last_name:string</span><br><span class="line">$ rails g migration add_user_ref_to_articles user:references</span><br><span class="line">$ rails g resource comment article:references body:text</span><br></pre></td></tr></table></figure>


<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> &lt; ApplicationRecord</span></span><br><span class="line">  <span class="keyword">include</span> Searchable <span class="comment"># magic goes there</span></span><br><span class="line"></span><br><span class="line">  belongs_to <span class="symbol">:user</span></span><br><span class="line"></span><br><span class="line">  has_many <span class="symbol">:comments</span>, <span class="symbol">dependent:</span> <span class="symbol">:destroy</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ApplicationRecord</span></span><br><span class="line">  has_many <span class="symbol">:articles</span>, <span class="symbol">dependent:</span> <span class="symbol">:destroy</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> &lt; ApplicationRecord</span></span><br><span class="line">  belongs_to <span class="symbol">:article</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># db/seeds.rb</span></span><br><span class="line">puts <span class="string">"Performing start"</span></span><br><span class="line"><span class="symbol">TODO:</span> CREATE INDEX</span><br><span class="line">Comment.destroy_all</span><br><span class="line">Article.destroy_all</span><br><span class="line">User.destroy_all</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.times <span class="keyword">do</span> <span class="params">|i|</span></span><br><span class="line">  User.create!(<span class="symbol">first_name:</span> FFaker::Name.first_name, <span class="symbol">last_name:</span> FFaker::Name.last_name)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>.times <span class="keyword">do</span> <span class="params">|i|</span></span><br><span class="line">  article = Article.create!(</span><br><span class="line">    <span class="symbol">title:</span> FFaker::Book.title, </span><br><span class="line">    <span class="symbol">body:</span> FFaker::Tweet.body,</span><br><span class="line">    <span class="symbol">user:</span> User.all.sample</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  (<span class="number">0</span>..<span class="number">2</span>).to_a.sample.times <span class="keyword">do</span></span><br><span class="line">    article.comments &lt;&lt; Comment.new(<span class="symbol">body:</span> FFaker::FreedomIpsum.paragraph)</span><br><span class="line">    article.save</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  puts i</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># puts 'import'</span></span><br><span class="line"><span class="comment"># Article.import</span></span><br><span class="line">puts <span class="string">"Performing stop"</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Searchable</span></span></span><br><span class="line">  extend ActiveSupport::Concern</span><br><span class="line"></span><br><span class="line">  included <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">include</span> Elasticsearch::Model</span><br><span class="line">    <span class="keyword">include</span> Elasticsearch::Model::Callbacks</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Mappings</span></span><br><span class="line">    mapping <span class="keyword">do</span></span><br><span class="line">      <span class="comment"># Article fields</span></span><br><span class="line">      indexes <span class="symbol">:title</span>, <span class="symbol">type:</span> <span class="symbol">:text</span></span><br><span class="line">      indexes <span class="symbol">:body</span>, <span class="symbol">type:</span> <span class="symbol">:text</span></span><br><span class="line">      <span class="comment"># belongs_to user</span></span><br><span class="line">      indexes <span class="symbol">:user</span>, <span class="symbol">type:</span> <span class="symbol">:object</span> <span class="keyword">do</span> <span class="comment"># object type is default</span></span><br><span class="line">        indexes <span class="symbol">:first_name</span>, <span class="symbol">type:</span> <span class="symbol">:text</span></span><br><span class="line">        indexes <span class="symbol">:last_name</span>, <span class="symbol">type:</span> <span class="symbol">:text</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="comment"># has_many comments</span></span><br><span class="line">      indexes <span class="symbol">:comments</span>, <span class="symbol">type:</span> <span class="symbol">:object</span> <span class="keyword">do</span></span><br><span class="line">        indexes <span class="symbol">:body</span>, <span class="symbol">type:</span> <span class="symbol">:text</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Serialization within Elasticsearch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">as_indexed_json</span><span class="params">(options = &#123;&#125;)</span></span></span><br><span class="line">      as_json(</span><br><span class="line">        <span class="symbol">only:</span> [<span class="string">'title'</span>, <span class="string">'body'</span>],</span><br><span class="line">        <span class="symbol">include:</span> &#123; </span><br><span class="line">          <span class="symbol">user:</span> &#123; <span class="symbol">only:</span> [<span class="symbol">:first_name</span>, <span class="symbol">:last_name</span>] &#125;,</span><br><span class="line">          <span class="symbol">comments:</span>   &#123; <span class="symbol">only:</span> <span class="symbol">:body</span> &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">### GET articles/_doc/64091 </span></span><br><span class="line">    <span class="comment"># &#123;</span></span><br><span class="line">    <span class="comment">#   "_index" : "articles",</span></span><br><span class="line">    <span class="comment">#   "_type" : "_doc",</span></span><br><span class="line">    <span class="comment">#   "_id" : "64091",</span></span><br><span class="line">    <span class="comment">#   "_version" : 1,</span></span><br><span class="line">    <span class="comment">#   "_seq_no" : 243,</span></span><br><span class="line">    <span class="comment">#   "_primary_term" : 3,</span></span><br><span class="line">    <span class="comment">#   "found" : true,</span></span><br><span class="line">    <span class="comment">#   "_source" : &#123;</span></span><br><span class="line">    <span class="comment">#     "title" : "Bloody Monster",</span></span><br><span class="line">    <span class="comment">#     "body" : "Voluptate laudantium expedita commodi hic odio neque quisquam. Deleniti cupiditate mollitia animi aspernatur. Ex perferendis repudiandae.",</span></span><br><span class="line">    <span class="comment">#     "user" : &#123;</span></span><br><span class="line">    <span class="comment">#       "first_name" : "Willis",</span></span><br><span class="line">    <span class="comment">#       "last_name" : "Nitzsche"</span></span><br><span class="line">    <span class="comment">#     &#125;,</span></span><br><span class="line">    <span class="comment">#     "comments" : [</span></span><br><span class="line">    <span class="comment">#       &#123;</span></span><br><span class="line">    <span class="comment">#         "body" : "Dallas cowboys 7-Eleven MGD 18-wheeler Harley Davidson anti-metric system. Super bowl propane tanks NASA jean shorts potato salad drone strike MOPAR tomahawk cruise missile velcro. John cena juicy flame-grilled shock and awe extra beef national security monster truck rally Fox News Call of Duty Starbucks. Garth brooks Applebee's apple pie Championship Pro Bass Fishing John Cena condiments extra beef."</span></span><br><span class="line">    <span class="comment">#       &#125;</span></span><br><span class="line">    <span class="comment">#     ]</span></span><br><span class="line">    <span class="comment">#   &#125;</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Our first query</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">search</span><span class="params">(query)</span></span></span><br><span class="line">      params = &#123;</span><br><span class="line">        <span class="symbol">query:</span> &#123;</span><br><span class="line">          <span class="symbol">multi_match:</span> &#123;</span><br><span class="line">            <span class="symbol">query:</span> query,</span><br><span class="line">            <span class="string">"fields"</span>: [</span><br><span class="line">              <span class="string">"title"</span>, </span><br><span class="line">              <span class="string">"body"</span>, </span><br><span class="line">              <span class="string">"user.first_name"</span>, </span><br><span class="line">              <span class="string">"user.last_name"</span>, </span><br><span class="line">              <span class="string">"comments.body"</span></span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">###</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># GET articles/_search</span></span><br><span class="line">      <span class="comment"># &#123;</span></span><br><span class="line">      <span class="comment">#   "query": &#123;</span></span><br><span class="line">      <span class="comment">#     "multi_match": &#123;</span></span><br><span class="line">      <span class="comment">#       "query": "alive",</span></span><br><span class="line">      <span class="comment">#       "fields": ["comments.body"]</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">#     &#125;</span></span><br><span class="line">      <span class="comment">#   &#125;</span></span><br><span class="line">      <span class="comment"># &#125;</span></span><br><span class="line">      &#123;</span><br><span class="line">      <span class="comment">#   "took" : 0,</span></span><br><span class="line">      <span class="comment">#   "timed_out" : false,</span></span><br><span class="line">      <span class="comment">#   "_shards" : &#123;</span></span><br><span class="line">      <span class="comment">#     "total" : 1,</span></span><br><span class="line">      <span class="comment">#     "successful" : 1,</span></span><br><span class="line">      <span class="comment">#     "skipped" : 0,</span></span><br><span class="line">      <span class="comment">#     "failed" : 0</span></span><br><span class="line">      <span class="comment">#   &#125;,</span></span><br><span class="line">      <span class="comment">#   "hits" : &#123;</span></span><br><span class="line">      <span class="comment">#     "total" : &#123;</span></span><br><span class="line">      <span class="comment">#       "value" : 2,</span></span><br><span class="line">      <span class="comment">#       "relation" : "eq"</span></span><br><span class="line">      <span class="comment">#     &#125;,</span></span><br><span class="line">      <span class="comment">#     "max_score" : 0.58432883,</span></span><br><span class="line">      <span class="comment">#     "hits" : [</span></span><br><span class="line">      <span class="comment">#       &#123;</span></span><br><span class="line">      <span class="comment">#         "_index" : "articles",</span></span><br><span class="line">      <span class="comment">#         "_type" : "_doc",</span></span><br><span class="line">      <span class="comment">#         "_id" : "64092",</span></span><br><span class="line">      <span class="comment">#         "_score" : 0.58432883,</span></span><br><span class="line">      <span class="comment">#         "_source" : &#123;</span></span><br><span class="line">      <span class="comment">#           "title" : "Champagne Brain",</span></span><br><span class="line">      <span class="comment">#           "body" : "Expedita repellat accusamus provident hic. Quisquam inventore eligendi error ratione illo. Maxime dolore quidem voluptates qui. Nesciunt.",</span></span><br><span class="line">      <span class="comment">#           "user" : &#123;</span></span><br><span class="line">      <span class="comment">#             "first_name" : "Peggie",</span></span><br><span class="line">      <span class="comment">#             "last_name" : "Lang"</span></span><br><span class="line">      <span class="comment">#           &#125;,</span></span><br><span class="line">      <span class="comment">#           "comments" : [</span></span><br><span class="line">      <span class="comment">#             &#123;</span></span><br><span class="line">      <span class="comment">#               "body" : "Wanted dead or alive super bowl stars and stripes Van Halen Championship Pro Bass Fishing. Xxxl stars and stripes border wall redwood Garth Brooks commies get out of my country MGD. Lunchables Chuck Norris more bullets national security official sponsor tomahawk cruise missile Dallas Cowboys Hot Pockets bald eagles."</span></span><br><span class="line">      <span class="comment">#             &#125;</span></span><br><span class="line">      <span class="comment">#           ]</span></span><br><span class="line">      <span class="comment">#         &#125;</span></span><br><span class="line">      <span class="comment">#       &#125;,</span></span><br><span class="line">      <span class="comment">#       &#123;</span></span><br><span class="line">      <span class="comment">#         "_index" : "articles",</span></span><br><span class="line">      <span class="comment">#         "_type" : "_doc",</span></span><br><span class="line">      <span class="comment">#         "_id" : "64093",</span></span><br><span class="line">      <span class="comment">#         "_score" : 0.4051479,</span></span><br><span class="line">      <span class="comment">#         "_source" : &#123;</span></span><br><span class="line">      <span class="comment">#           "title" : "Action Tears",</span></span><br><span class="line">      <span class="comment">#           "body" : "Commodi atque voluptatum porro placeat. Commodi eum ea consequatur illo iste autem. Voluptatem quia error dicta quis debitis ut voluptates.",</span></span><br><span class="line">      <span class="comment">#           "user" : &#123;</span></span><br><span class="line">      <span class="comment">#             "first_name" : "Peggie",</span></span><br><span class="line">      <span class="comment">#             "last_name" : "Lang"</span></span><br><span class="line">      <span class="comment">#           &#125;,</span></span><br><span class="line">      <span class="comment">#           "comments" : [</span></span><br><span class="line">      <span class="comment">#             &#123;</span></span><br><span class="line">      <span class="comment">#               "body" : "Shopping John Wayne propane tanks DiGiorno Medal of Honor foreign policy. Fbi cia nsa hot dogs the media extra pulled pork WMD Star-Spangled Banner congress. Applebee's tomahawk cruise missile fireworks malls God Bless America red white and blue wanted dead or alive. Pro-wrestling dual-wielded machine guns I only speak American democracy ESPN2."</span></span><br><span class="line">      <span class="comment">#             &#125;,</span></span><br><span class="line">      <span class="comment">#             &#123;</span></span><br><span class="line">      <span class="comment">#               "body" : "Liberty 7-Eleven Denny's Grand Slam Breakfast Lynyrd Skynyrd truthers independence 3D Blu-Ray shopping enemies of freedom. Texas mud flaps bald eagles crispy chicken strips Medal of Honor 7-Eleven Checkers NASA. Southwest breakfast burrito Branson Missouri Wal-Mart Chuck Norris 7-Eleven Arnold Schwarzenegger democracy 85oz soda. Pickup trucks DirecTV velcro Chuck Norris microwaved patriotic the government extra beef. Super bowl TGIF credit cards mission accomplished Marlboro reds SUVs 1776 Garth Brooks."</span></span><br><span class="line">      <span class="comment">#             &#125;</span></span><br><span class="line">      <span class="comment">#           ]</span></span><br><span class="line">      <span class="comment">#         &#125;</span></span><br><span class="line">      <span class="comment">#       &#125;</span></span><br><span class="line">      <span class="comment">#     ]</span></span><br><span class="line">      <span class="comment">#   &#125;</span></span><br><span class="line">      <span class="comment"># &#125;</span></span><br><span class="line">      <span class="keyword">self</span>.__elasticsearch_<span class="number">_</span>.search(params).records.to_a</span><br><span class="line">    <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Keeping-index-in-sync-with-data"><a href="#Keeping-index-in-sync-with-data" class="headerlink" title="Keeping index in sync with data"></a>Keeping index in sync with data</h3><p>We have a relationships within our articles index and we want to keep index up to date. So every change of comment should update coresponding artile document with that comments and every change in user should update documents with that user. Let’s dive in.</p>
<h6 id="Article-has-many-comments"><a href="#Article-has-many-comments" class="headerlink" title="Article.has_many.comments"></a>Article.has_many.comments</h6><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> &lt; ApplicationRecord</span></span><br><span class="line">  belongs_to <span class="symbol">:article</span>, <span class="symbol">touch:</span> <span class="literal">true</span> <span class="comment"># add touch: true </span></span><br><span class="line">  <span class="comment"># associated object will be touched (the updated_at / updated_on attributes set to current time) when this record is either saved or destroyed. </span></span><br><span class="line">  <span class="comment"># (...)</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Searchable</span></span></span><br><span class="line">  included <span class="keyword">do</span></span><br><span class="line">    after_touch() &#123; __elasticsearch_<span class="number">_</span>.index_document &#125; <span class="comment"># add after_touch callback</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment"># (...)</span></span><br></pre></td></tr></table></figure>
<h6 id="Article-belongs-to-user"><a href="#Article-belongs-to-user" class="headerlink" title="Article.belongs_to.user"></a>Article.belongs_to.user</h6><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ApplicationRecord</span></span><br><span class="line">  after_update &#123; <span class="keyword">self</span>.articles.each(&amp;<span class="symbol">:touch</span>) &#125; <span class="comment"># add after_update callback</span></span><br><span class="line">  <span class="comment"># (...)</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Banchmarks"><a href="#Banchmarks" class="headerlink" title="Banchmarks"></a>Banchmarks</h3><p>Article.all =&gt; 45300</p>
<p>Rendered layout layouts/application.html.erb (Duration: 10556.6ms | Allocations: 5679024)<br>Completed 200 OK in 10558ms (Views: 10520.9ms | ActiveRecord: 36.3ms | Allocations: 5679325)</p>
<p>10.558 seconds<br>Completed 200 OK in 30314ms</p>
<p>Article.match_all =&gt; 45300</p>
<p>Completed 200 OK in 90763ms (Views: 48884.5ms | ActiveRecord: 41875.3ms | Allocations: 203877009)</p>
<p>44295ms</p>
<p>90.763</p>
<h5 id="Querying"><a href="#Querying" class="headerlink" title="Querying"></a>Querying</h5><h5 id="Write"><a href="#Write" class="headerlink" title="Write"></a>Write</h5><h3 id="See-on-large-dataset"><a href="#See-on-large-dataset" class="headerlink" title="See on large dataset"></a>See on large dataset</h3><h1 id="Pagination"><a href="#Pagination" class="headerlink" title="Pagination"></a>Pagination</h1><h2 id="kaminari"><a href="#kaminari" class="headerlink" title="kaminari"></a>kaminari</h2><h2 id="will-paginate"><a href="#will-paginate" class="headerlink" title="will_paginate"></a>will_paginate</h2></div></article></div></main><footer><div class="paginator"><a class="prev" href="/2021/01/09/how-to-build-nested-form-ala-rails-with-phoenix-liveview/"><i class="fa fa-arrow-left" aria-hidden="true"></i></a></div><div class="fb-comments-area"><div class="fb-comments" data-href="http://rafaltrojanowski.github.io/2024/04/04/full-text-search-with-elasticsearch-in-rails/" data-width="700" data-numposts="5"></div></div><div class="copyright"><p>© 2012 - 2024 <a href="https://github.com/stunstunstun" target="_blank">Rafał Trojanowski</a>. Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/stunstunstun/hexo-theme-chiangmai" target="_blank">hexo-theme-chiangmai</a>.</p></div></footer></div><script>window.fbAsyncInit=function(){FB.init({appId:"1279423065775877",cookie:!0,xfbml:!0,version:"v2.8"}),FB.AppEvents.logPageView()},function(e,n,t){var o,c=e.getElementsByTagName(n)[0];e.getElementById(t)||((o=e.createElement(n)).id=t,o.src="//connect.facebook.net/en_US/sdk.js",c.parentNode.insertBefore(o,c))}(document,"script","facebook-jssdk");</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create','UA-112438069-1','auto');ga('send','pageview');</script></body></html>