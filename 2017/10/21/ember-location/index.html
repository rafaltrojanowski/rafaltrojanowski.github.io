<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Redirect back with Ember.Location · Rafal Trojanowski - Ruby on Rails Developer</title><meta name="description" content="I'm remote Ruby on Rails Developer based in Poland"><meta name="og:title" content="Redirect back with Ember.Location"><meta name="og:type" content="website"><meta name="og:url" content="http://rafaltrojanowski.github.io/2017/10/21/ember-location/"><meta name="og:image" content="http://image.toast.com/aaaaahq/hola_cover.JPG"><meta name="og:description" content="I'm remote Ruby on Rails Developer based in Poland"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/chiangmai.css"><meta name="steem:author" content="@stunstunstun"><link rel="search" type="application/opensearchdescription+xml" href="http://rafaltrojanowski.github.io/atom.xml" title="Rafal Trojanowski - Ruby on Rails Developer"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Rafal Trojanowski - Ruby on Rails Developer" type="application/atom+xml">
</head><body class="post"><div id="fb-root"></div><div class="wrap"><header><nav class="navi-post"><a class="navi-post-back" href="javascript:history.back()"><i class="fa fa-arrow-left" aria-hidden="true"></i></a><a class="navi-post-home" href="/"><i class="fa fa-home" aria-hidden="true"></i></a></nav></header><main class="post"><div class="post"><article class="post-block"><h1 class="post-title">Redirect back with Ember.Location</h1><div class="post-info"><div class="post-info-profile"><a href="https://github.com/rafaltrojanowski" target="_blank"><img src="/image/rt-avatar.jpeg"></a></div><div class="post-info-details"><div class="post-categories"></div><div class="post-date">Oct 21, 2017</div></div></div><div class="post-share"><div class="fb-like" data-href="http://rafaltrojanowski.github.io/2017/10/21/ember-location/" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="false">                 </div><div class="fb-share-button" data-href="http://rafaltrojanowski.github.io/2017/10/21/ember-location/" data-layout="button" data-size="small" data-mobile-iframe="true"></div></div><div class="post-content"><h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>In the approach with routable modal described in previous posts, there is one drawback. Closing link located in the modal needs to be handled with additional logic if we want to achieve the same effect when we don’t use a routable approach. In the routable approach we open modal for a specific route so close action needs to make a redirect to the previous route from the history.</p>
<p>We can handle closing modal by simple link-to pointing to the main application route. </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;#full-screen-modal-dialog&#125;&#125;</span><br><span class="line">  &#123;&#123;#link-to "application"&#125;&#125;Close&#123;&#123;/link-to&#125;&#125;</span><br><span class="line">&#123;&#123;/full-screen-modal-dialog&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>But what when we want to redirect the user to the previous view, similarly like when the user clicks on the back button in the browser?</p>
<p>There is a problem with how to track the history of visited routes. I was researching a long time and found a few solutions:</p>
<ol>
<li><p>Use dedicated add-ons:</p>
<ul>
<li><code>ember-cli-history-mixin</code></li>
<li><code>ember-route-history</code></li>
</ul>
<p>Disadvantage: Seems to be not maintained and problems with recording the history of nested routes. Generally fetching ids from the router object is hard.</p>
</li>
<li><p>Use <code>window.history.back()</code></p>
</li>
</ol>
<p>That looks fine but doesn’t work the same way in all browsers. Also, it would redirect the user outside the app.</p>
<ol start="3">
<li>Some code snippets on Stackoverflow which hacks router to extract previous route state.</li>
</ol>
<p>The code seems quite complicated and hacky.</p>
<p>Finally, I chose a solution on this blog: <a href="http://kiprosh.com/blog/ember-js-how-to-track-last-visited-route" target="_blank" rel="noopener">http://kiprosh.com/blog/ember-js-how-to-track-last-visited-route</a></p>
<p>Although, it wasn’t perfect, because it still didn’t work with nested routes.</p>
<p>On the occasion, I approached it with TDD believing that I will discover something new.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">'click on close redirects back to the previous route from nested routes'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">assert</span>) </span>&#123;</span><br><span class="line">  server.createList(<span class="string">'note'</span>, <span class="number">1</span>);</span><br><span class="line">  server.createList(<span class="string">'comment'</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  visit(<span class="string">'/note/1/comment/1'</span>);</span><br><span class="line"></span><br><span class="line">  andThen(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    assert.equal(currentURL(), <span class="string">'/note/1/comment/1'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  click(<span class="string">'a#search'</span>);</span><br><span class="line"></span><br><span class="line">  andThen(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    assert.equal(currentURL(), <span class="string">'/search'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  click(<span class="string">'a.search-close'</span>);</span><br><span class="line"></span><br><span class="line">  andThen(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    assert.equal(currentURL(), <span class="string">'/note/1/comment/1'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>…and started debugging and looking at router object, to retrieve some info current route path.</p>
<p>Happily, I found something new - <code>router.location.path</code> which stores the string. I was surprised. It looks like something new in Ember and doesn’t need to hack it to make a transition back.</p>
<p>So updated recording last visited route in beforeModel hook:</p>
<p><code>routes/search.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Ember <span class="keyword">from</span> <span class="string">'ember'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Route.extend(&#123;</span><br><span class="line"></span><br><span class="line">  beforeModel() &#123;</span><br><span class="line">    <span class="keyword">let</span> previousRoutes = <span class="keyword">this</span>.router.router.currentHandlerInfos;</span><br><span class="line">    <span class="keyword">let</span> previousRoute = previousRoutes &amp;&amp; previousRoutes.pop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (previousRoute &amp;&amp; previousRoute.name !== <span class="string">'search'</span>) &#123;</span><br><span class="line">      localStorage[<span class="string">'lastVisitedRoute'</span>] = previousRoute.name;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// use location path to store last visited route</span></span><br><span class="line">      localStorage[<span class="string">'lastVisitedRoutePath'</span>] = <span class="keyword">this</span>.router.location.path;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>routes/search.hbs</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;#full-screen-modal-dialog&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">'search-close'</span> &#123;&#123;<span class="attr">action</span> "<span class="attr">close</span>"&#125;&#125;&gt;</span>Close<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">&#123;&#123;/full-screen-modal-dialog&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><code>controllers/search.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Ember <span class="keyword">from</span> <span class="string">'ember'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Controller.extend(&#123;</span><br><span class="line">  actions: &#123;</span><br><span class="line">    close() &#123;</span><br><span class="line">      <span class="keyword">let</span> lastVisitedRoute = localStorage[<span class="string">'lastVisitedRoutePath'</span>] || <span class="string">"index"</span>;</span><br><span class="line">      <span class="keyword">this</span>.transitionToRoute(lastVisitedRoutePath);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>I was happy that I finally found a solution to the problem I was struggling for a long time. However I discovered something unexpected when I tested the app manually!! That didn’t work. Again using debugger I investigated that path is undefined and the router has a problem with transition. Say what!? The tests are green.</p>
<h2 id="Ember-Location-API"><a href="#Ember-Location-API" class="headerlink" title="Ember.Location API"></a>Ember.Location API</h2><p>I learned that Ember uses different strategies for routing location in test and development mode by default. You can see it when you look at <code>config/environment.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">environment</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> ENV = &#123;</span><br><span class="line">    <span class="comment">// (...)</span></span><br><span class="line">    locationType: <span class="string">'auto'</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// (...)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (environment === <span class="string">'test'</span>) &#123;</span><br><span class="line">    <span class="comment">// Testem prefers this...</span></span><br><span class="line">    ENV.locationType = <span class="string">'none'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// (...)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Started digging in the docs (<a href="https://www.emberjs.com/api/ember/2.14.1/namespaces/Ember.Location" target="_blank" rel="noopener">https://www.emberjs.com/api/ember/2.14.1/namespaces/Ember.Location</a>) and source code to find more.</p>
<p>Generally, 4 types of location can be used by Ember:</p>
<h3 id="Ember-NoneLocation"><a href="#Ember-NoneLocation" class="headerlink" title="Ember.NoneLocation"></a>Ember.NoneLocation</h3><p>It’s used in tests. That makes sense because when test is running there is URL like:<br>I switched to this type in the development and then <code>router.location.path</code> was again accessible and redirection worked as expected. But URL was blank all the time, so I had to give up this solution.</p>
<p>That type could be also usable when you embed your Ember application on a larger page.</p>
<h3 id="Ember-HashLocation"><a href="#Ember-HashLocation" class="headerlink" title="Ember.HashLocation"></a>Ember.HashLocation</h3><p>This is the default. The characteristic thing is that it adds # on the beginning of the path in the URL.<br>I noticed that in the code introduced <code>router.location.lastSetPath</code> which sounds familiar and contains the same string with a full path like <code>router.location.path</code> in Ember.NoneLocation.</p>
<p>Note: the value is set only when a transition is performed by a router. In other words it won’t work on copy-paste an URL and hit Enter.</p>
<h3 id="Ember-HistoryLocation"><a href="#Ember-HistoryLocation" class="headerlink" title="Ember.HistoryLocation"></a>Ember.HistoryLocation</h3><p>Using HistoryLocation results in URLs that are indistinguishable from a standard URL. This relies upon the browser’s history API.</p>
<h3 id="Ember-AutoLocation"><a href="#Ember-AutoLocation" class="headerlink" title="Ember.AutoLocation"></a>Ember.AutoLocation</h3><p>Using AutoLocation, the router will use the best Location class supported by the browser it is running in.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>I resolved this problem by removing acceptance tests temporarily and in development / production - use hash location combined with storing last visited route like here:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localStorage[<span class="string">'lastVisitedRoutePath'</span>] = <span class="keyword">this</span>.router.location.lastSetPath;</span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2017/07/19/desing-fullscreen-search-interface-part-3/"><i class="fa fa-arrow-left" aria-hidden="true"></i></a><a class="next" href="/2018/12/04/ruby-array-conversion-function/"><i class="fa fa-arrow-right" aria-hidden="true"></i></a></div><div class="copyright"><p>© 2012 - 2024 <a href="https://github.com/stunstunstun" target="_blank">Rafał Trojanowski</a>. Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/stunstunstun/hexo-theme-chiangmai" target="_blank">hexo-theme-chiangmai</a>.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create','UA-112438069-1','auto');ga('send','pageview');</script></body></html>